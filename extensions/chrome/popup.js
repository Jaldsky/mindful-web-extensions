// Popup script for Mindful Web extension

class PopupManager {
    constructor() {
        this.init();
    }

    async init() {
        await this.loadStatus();
        this.setupEventListeners();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(() => {
            this.loadStatus();
        }, 2000);
    }

    setupEventListeners() {
        document.getElementById('openSettings').addEventListener('click', () => {
            chrome.runtime.openOptionsPage();
        });

        document.getElementById('testConnection').addEventListener('click', () => {
            this.testConnection();
        });

        document.getElementById('reloadExtension').addEventListener('click', () => {
            this.reloadExtension();
        });

        document.getElementById('runDiagnostics').addEventListener('click', () => {
            this.runDiagnostics();
        });
    }

    async loadStatus() {
        try {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å —Å –ø–æ–º–æ—â—å—é ping
            const pingResponse = await this.pingServiceWorker();
            
            if (pingResponse) {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ background script
                const response = await chrome.runtime.sendMessage({ action: 'getStatus' });
                
                if (response) {
                    this.updateConnectionStatus(response.isOnline);
                    this.updateTrackingStatus(response.isTracking);
                    this.updateStats(response.stats);
                } else {
                    this.updateConnectionStatus(false);
                    this.updateTrackingStatus(false);
                }
            } else {
                // Service worker –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
                this.updateConnectionStatus(false);
                this.updateTrackingStatus(false);
            }
        } catch (error) {
            console.error('Error loading status:', error);
            this.updateConnectionStatus(false);
            this.updateTrackingStatus(false);
        }
    }

    async pingServiceWorker() {
        try {
            const response = await chrome.runtime.sendMessage({ action: 'ping' });
            return response && response.success;
        } catch (error) {
            console.error('Ping failed:', error);
            return false;
        }
    }

    updateConnectionStatus(isOnline) {
        const statusElement = document.getElementById('connectionStatus');
        if (isOnline) {
            statusElement.textContent = 'Online';
            statusElement.className = 'status-value online';
        } else {
            statusElement.textContent = 'Offline';
            statusElement.className = 'status-value offline';
        }
    }

    updateTrackingStatus(isTracking) {
        const statusElement = document.getElementById('trackingStatus');
        if (isTracking) {
            statusElement.textContent = 'Active';
            statusElement.className = 'status-value active';
        } else {
            statusElement.textContent = 'Inactive';
            statusElement.className = 'status-value inactive';
        }
    }

    updateStats(stats) {
        if (stats) {
            document.getElementById('eventsCount').textContent = stats.eventsTracked || 0;
            document.getElementById('domainsCount').textContent = stats.domainsVisited || 0;
            document.getElementById('queueSize').textContent = stats.queueSize || 0;
        }
    }

    async testConnection() {
        const button = document.getElementById('testConnection');
        const originalText = button.textContent;
        
        button.textContent = 'Testing...';
        button.disabled = true;
        
        try {
            console.log('Starting connection test...');
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å —Å service worker
            const pingResponse = await this.pingServiceWorker();
            
            if (!pingResponse) {
                this.showNotification('Service worker not responding. Please reload the extension.', 'error');
                return;
            }
            
            // –¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É
            const response = await chrome.runtime.sendMessage({ action: 'testConnection' });
            console.log('Connection test response:', response);
            
            if (response && response.success) {
                this.showNotification('Connection successful!', 'success');
            } else if (response) {
                this.showNotification('Backend connection failed: ' + response.error, 'error');
            } else {
                this.showNotification('No response from service worker', 'error');
            }
        } catch (error) {
            console.error('Connection test error:', error);
            
            if (error.message.includes('Receiving end does not exist')) {
                this.showNotification('Extension not active. Please reload the extension.', 'error');
            } else {
                this.showNotification('Connection test failed: ' + error.message, 'error');
            }
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    reloadExtension() {
        try {
            chrome.runtime.reload();
            this.showNotification('Extension reloaded!', 'success');
        } catch (error) {
            console.error('Error reloading extension:', error);
            this.showNotification('Failed to reload extension', 'error');
        }
    }

    async runDiagnostics() {
        const button = document.getElementById('runDiagnostics');
        const originalText = button.textContent;
        
        button.textContent = 'Running...';
        button.disabled = true;
        
        try {
            console.log('Running diagnostics...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Chrome APIs
            if (typeof chrome === 'undefined') {
                this.showNotification('‚ùå Chrome APIs not available. This popup is not running in extension context.', 'error');
                return;
            }
            
            if (!chrome.runtime) {
                this.showNotification('‚ùå chrome.runtime not available. Extension may not be properly loaded.', 'error');
                return;
            }
            
            console.log('Chrome APIs available, testing service worker...');
            
            // –¢–µ—Å—Ç 1: Ping service worker —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
            let pingResult = false;
            let pingError = null;
            try {
                console.log('Sending ping message...');
                const pingResponse = await chrome.runtime.sendMessage({ action: 'ping' });
                console.log('Ping response received:', pingResponse);
                pingResult = pingResponse && pingResponse.success;
            } catch (error) {
                console.error('Ping failed with error:', error);
                pingError = error.message;
            }
            
            // –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            let statusResult = false;
            let statusError = null;
            if (pingResult) {
                try {
                    console.log('Testing status API...');
                    const response = await chrome.runtime.sendMessage({ action: 'getStatus' });
                    console.log('Status response:', response);
                    statusResult = !!response;
                } catch (error) {
                    console.error('Status test failed:', error);
                    statusError = error.message;
                }
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞
            let backendResult = false;
            let backendError = null;
            if (pingResult) {
                try {
                    console.log('Testing backend connection...');
                    const response = await chrome.runtime.sendMessage({ action: 'testConnection' });
                    console.log('Backend response:', response);
                    backendResult = response && response.success;
                    if (!backendResult && response) {
                        backendError = response.error;
                    }
                } catch (error) {
                    console.error('Backend test failed:', error);
                    backendError = error.message;
                }
            }
            
            // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            const results = [];
            results.push(`üîç Service Worker: ${pingResult ? '‚úÖ OK' : `‚ùå FAILED${pingError ? ' (' + pingError + ')' : ''}`}`);
            results.push(`üìä Status API: ${statusResult ? '‚úÖ OK' : `‚ùå FAILED${statusError ? ' (' + statusError + ')' : ''}`}`);
            results.push(`üåê Backend API: ${backendResult ? '‚úÖ OK' : `‚ùå FAILED${backendError ? ' (' + backendError + ')' : ''}`}`);
            
            const allGood = pingResult && statusResult && backendResult;
            const message = results.join('\n');
            
            if (allGood) {
                this.showNotification('All diagnostics passed! ‚úÖ', 'success');
            } else {
                this.showNotification(`Diagnostics completed:\n${message}`, 'error');
            }
            
            console.log('Diagnostics completed:', { pingResult, statusResult, backendResult, pingError, statusError, backendError });
            
        } catch (error) {
            console.error('Diagnostics error:', error);
            this.showNotification('Diagnostics failed: ' + error.message, 'error');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    showNotification(message, type) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            z-index: 1000;
            ${type === 'success' ? 
                'background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 
                'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
            }
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    new PopupManager();
});
